<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino BLE Sensor Dashboard with Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script> 
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            color: #333;
            margin-top: 30px;
        }
        #controls {
            margin-bottom: 20px;
        }
        #chart-container {
            width: 90%;
            max-width: 1200px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #connect-button {
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #connect-button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 10px;
            font-size: 1em;
            color: orange;
        }
    </style>
</head>
<body>

    <h2>BLE Sensor Time Graph</h2>
    <div id="controls">
        <button id="connect-button" onclick="connectAndRead()">Connect to Arduino BLE</button>
        <p id="status">Status: Waiting to connect...</p>
    </div>
    
    <div id="chart-container">
        <canvas id="sensorChart"></canvas>
    </div>

    <script>
        // --- 1. UUID Definitions & Chart Initialization ---
        const SERVICE_UUID = '74e39e63-a1fb-446f-a700-6d9fa8c8c858';
        const TEXT_CHAR_UUID = '74e39e63-a1fb-446f-a701-6d9fa8c8c858';
        
        const MAX_DATA_POINTS = 50; // Limit the chart history to 50 points

        let bleDevice;
        let sensorCharacteristic;
        const statusElement = document.getElementById('status');
        
        let tempChart;
        let chartData = {
            labels: [], // Time stamps
            temperature: [],
            humidity: []
        };
        
        // --- Initialize Chart.js ---
        window.onload = function() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: chartData.temperature,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            yAxisID: 'yTemp'
                        },
                        {
                            label: 'Humidity (%)',
                            data: chartData.humidity,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            yAxisID: 'yHumid'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            title: { display: true, text: 'Time' }
                        },
                        yTemp: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Temperature (°C)' }
                        },
                        yHumid: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Humidity (%)' },
                            grid: { drawOnChartArea: false } // Only draw grid lines for Temp axis
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Live Temperature and Humidity' }
                    }
                }
            });
        };


        // --- 2. Connection Logic (Same as before) ---
        async function connectAndRead() {
            if (!navigator.bluetooth) {
                statusElement.textContent = 'Error: Web Bluetooth is not supported by this browser.';
                return;
            }

            try {
                statusElement.textContent = 'Scanning for devices...';
                
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID]
                });

                statusElement.textContent = `Connecting to ${bleDevice.name || 'Device'}...`;

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                sensorCharacteristic = await service.getCharacteristic(TEXT_CHAR_UUID);
                
                statusElement.textContent = 'Connected! Starting notifications...';

                await sensorCharacteristic.startNotifications();
                sensorCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                document.getElementById('connect-button').disabled = true;

            } catch(error) {
                statusElement.textContent = `Connection Error: ${error.message}`;
                document.getElementById('connect-button').disabled = false;
                console.error('BLE Error:', error);
            }
        }
        
        function onDisconnected(event) {
            statusElement.textContent = `Disconnected from ${event.target.name || 'device'}.`;
            document.getElementById('connect-button').disabled = false;
        }

        // --- 3. Notification, Parsing, and Chart Update Logic ---
        function handleNotifications(event) {
            const value = event.target.value; 
            const decoder = new TextDecoder('utf-8');
            const sensorString = decoder.decode(value);

            statusElement.textContent = `Status: Live Data (Last update: ${new Date().toLocaleTimeString()})`;
            
            parseAndDisplayData(sensorString);
        }

        function parseAndDisplayData(dataString) {
            // Regex to match the Arduino String format: "T:XX.XC | H:XX.X% | A(X:XX.XX, Y:XX.XX, Z:XX.XX)"
            // We only need the first two capture groups (Temperature and Humidity) for the chart.
            const regex = /T:([\d.-]+)C \| H:([\d.-]+)% \| A\(X:([\d.-]+), Y:([\d.-]+), Z:([\d.-]+)\)/;
            const match = dataString.match(regex);

            if (match) {
                const temp = parseFloat(match[1]);
                const humidity = parseFloat(match[2]);
                const timeLabel = new Date().toLocaleTimeString();

                // 1. Add new data point
                chartData.labels.push(timeLabel);
                chartData.temperature.push(temp);
                chartData.humidity.push(humidity);

                // 2. Remove oldest data point if limit is exceeded
                if (chartData.labels.length > MAX_DATA_POINTS) {
                    chartData.labels.shift();
                    chartData.temperature.shift();
                    chartData.humidity.shift();
                }

                // 3. Update the chart
                tempChart.update();

            } else {
                console.warn("Received string format did not match expected pattern:", dataString);
            }
        }
    </script>
</body>
</html>